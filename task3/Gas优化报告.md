# Gas 优化报告

## 概述
本报告对比了原始 `Arithmetic` 合约与使用不同优化策略的两个优化版本的 gas 消耗情况。

## 优化策略

### OptimizedArithmetic1: 纯函数（无状态存储）
**策略**: 移除所有状态变量并将函数转换为 `pure`
- **主要变更**:
  - 移除所有 `latestXXXResult` 状态变量
  - 将函数从状态修改型改为 `pure` 类型
  - 消除所有 SSTORE 操作（最昂贵的操作）

### OptimizedArithmetic2: Unchecked 算术 + 自定义错误
**策略**: 使用 `unchecked` 代码块和自定义错误
- **主要变更**:
  - 用 `unchecked` 代码块包装算术运算
  - 用自定义错误替换除零检查的 `require`
  - 保留状态存储以保持兼容性

## Gas 消耗对比

### 部署成本
| Contract | Deployment Cost | Deployment Size | Savings vs Original |
|----------|----------------|-----------------|---------------------|
| Arithmetic (Original) | 331,702 | 1,321 字节 | - |
| OptimizedArithmetic1 | 280,421 | 1,084 字节 | **51,281 gas (15.5%)** |
| OptimizedArithmetic2 | 246,156 | 923 字节 | **85,546 gas (25.8%)** |

### 函数调用成本（平均 Gas）

#### 加法函数
| Contract | Min | Avg | Median | Max | Savings vs Original |
|----------|-----|-----|--------|-----|---------------------|
| Arithmetic | 44,571 | 44,789 | 44,763 | 45,255 | - |
| OptimizedArithmetic1 | 970 | 970 | 970 | 970 | **43,819 gas (97.8%)** ✨ |
| OptimizedArithmetic2 | 44,305 | 44,522 | 44,485 | 45,025 | **267 gas (0.6%)** |

#### 减法函数
| Contract | Min | Avg | Median | Max | Savings vs Original |
|----------|-----|-----|--------|-----|---------------------|
| Arithmetic | 44,551 | 44,799 | 44,803 | 45,271 | - |
| OptimizedArithmetic1 | 948 | 948 | 948 | 948 | **43,851 gas (97.9%)** ✨ |
| OptimizedArithmetic2 | 24,408 | 44,344 | 44,392 | 45,028 | **455 gas (1.0%)** |

#### 乘法函数
| Contract | Min | Avg | Median | Max | Savings vs Original |
|----------|-----|-----|--------|-----|---------------------|
| Arithmetic | 24,692 | 44,013 | 44,616 | 44,964 | - |
| OptimizedArithmetic1 | 989 | 989 | 989 | 989 | **43,024 gas (97.8%)** ✨ |
| OptimizedArithmetic2 | 24,424 | 43,917 | 44,312 | 44,636 | **96 gas (0.2%)** |

#### 除法函数
| Contract | Min | Avg | Median | Max | Savings vs Original |
|----------|-----|-----|--------|-----|---------------------|
| Arithmetic | 22,251 | 34,312 | 25,295 | 45,261 | - |
| OptimizedArithmetic1 | 919 | 1,006 | 1,007 | 1,007 | **33,306 gas (97.1%)** ✨ |
| OptimizedArithmetic2 | 22,002 | 35,054 | 44,336 | 44,984 | **-742 gas (-2.2%)** |

### 测试函数成本 (gas)
| Test | Arithmetic | OptimizedArithmetic1 | OptimizedArithmetic2 |
|------|-----------|---------------------|---------------------|
| test_Add | 50,559 | 6,956 | 50,293 |
| test_Subtract | 50,561 | 6,956 | 50,294 |
| test_Multiply | 50,602 | 6,997 | 50,274 |
| test_Divide | 50,597 | 7,037 | 50,356 |
| test_DivideByZero | 31,248 | 9,914 | 30,917 |

## 分析

### OptimizedArithmetic1 (纯函数) 🏆
**大多数使用场景的赢家！**

✅ **优点**:
- **大幅节省 gas**: 函数调用成本降低 97-98%
- 消除了昂贵的 SSTORE 操作（每次约 20,000 gas）
- 最小的代码体积（1,084 字节）
- 最安全（没有可操纵的状态）
- 最适合无状态计算

❌ **缺点**:
- 无法跟踪历史结果
- 不适合需要状态持久化的场景
- 改变了合约接口行为

**最适合**: 只需要计算结果而不需要状态持久化的应用（大多数 DeFi 计算、视图函数、库）

### OptimizedArithmetic2 (Unchecked + 自定义错误)
**状态保留优化的赢家！**

✅ **优点**:
- 保持状态存储兼容性
- 部署成本低于原始版本（节省 25.8%）
- 运行时 gas 小幅节省（0.2-1.0%）
- 自定义错误在回滚时节省约 50 gas
- 最佳部署大小（923 字节）

❌ **缺点**:
- 运行时 gas 节省最小
- `unchecked` 代码块需要仔细验证
- 仍需支付 SSTORE 成本（每次写入约 20,000 gas）
- 需要调用者确保不会溢出/下溢

**最适合**: 需要在优化部署成本的同时保持状态的应用，且调用者可以保证算术运算的安全性

## 关键 Gas 成本洞察

1. **SSTORE 是最大开销**: 每次状态变量写入成本约 20,000 gas
2. **纯函数便宜 98%**: 无状态 = 大幅节省
3. **Unchecked 数学节省 3-6%**: 但仅在不可能溢出时有效
4. **自定义错误节省约 50 gas**: 优于 require 字符串
5. **部署优化很重要**: 部署成本降低 25%

## 建议

### 何时使用 OptimizedArithmetic1:
- 简单的计算器或数学库
- DeFi 协议（价格计算、比率等）
- View/pure 辅助函数
- 不需要状态持久化时

### 何时使用 OptimizedArithmetic2:
- 需要保持状态以保证兼容性
- 分析/追踪需求
- 部署成本很重要时
- 可控环境且输入已验证

### 何时使用原始 Arithmetic:
- 学习/教育目的
- 使用 Solidity 0.8+ 溢出保护的最大安全性
- 不可信的用户输入

## 额外的优化想法

未来改进方向:
1. **事件代替状态**: 将结果作为事件发出（廉价的日志记录）
2. **结构体打包**: 在一个存储槽中打包多个 uint128
3. **不可变变量**: 对常量使用 immutable
4. **汇编**: 关键路径可以使用内联汇编
5. **批量操作**: 在一次交易中处理多个操作

## 结论

**OptimizedArithmetic1** 通过消除状态存储实现了最佳的 gas 优化，节省 97-98%。这是大多数不需要状态持久化的使用场景的推荐方法。

**OptimizedArithmetic2** 在保持状态存储兼容性的同时提供了更适度的优化，适合需要跟踪历史结果或保持向后兼容性的应用。

选择取决于您的具体需求:
- 需要状态？ → OptimizedArithmetic2
- 纯计算？ → OptimizedArithmetic1
